name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ECSæœåŠ¡å™¨

on:
  push:
<<<<<<< HEAD
    branches: [ 1.0.1 ]  # è§¦å‘åˆ†æ”¯

env:
  SERVER_IP: 8.155.16.247
  DEPLOY_DIR: /var/www/yaren-server
=======
    branches: [ main ]  # æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è°ƒæ•´ï¼Œå¯èƒ½æ˜¯ main æˆ– master
    paths: 
      - 'server/**'     # åªæœ‰å½“ server ç›®å½•ä¸­çš„æ–‡ä»¶å˜æ›´æ—¶æ‰è§¦å‘
>>>>>>> 48c938b10b3bd948b78d7ef2d4cb3cafafeb2f29

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
<<<<<<< HEAD
      - name:  æ£€å‡ºä»£ç 
        uses: actions/checkout@v3  # å‡çº§åˆ°æœ€æ–°ç‰ˆ

      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts  # é¢„ç½®ä¸»æœºæŒ‡çº¹æå‡å®‰å…¨æ€§

      - name: æµ‹è¯•SSHè¿æ¥ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
        run: |
          ssh -vvv \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -i ~/.ssh/id_rsa \
            root@${{ env.SERVER_IP }} \
            "echo 'âœ… SSHè¿æ¥æˆåŠŸï¼æœåŠ¡å™¨æ—¶é—´: $(date)'"

      - name: æ‰“åŒ…ä»£ç ï¼ˆæ’é™¤æ— ç”¨æ–‡ä»¶ï¼‰
        run: |
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.env' \
              --exclude='*.log' \
              -czf deploy.tar.gz .

      - name: ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨
        run: |
          scp -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=yes \
              deploy.tar.gz root@${{ env.SERVER_IP }}:${{ env.DEPLOY_DIR }}

      - name: æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ env.SERVER_IP }} << EOF
            set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³ç»ˆæ­¢
            cd $DEPLOY_DIR
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            npm ci --only=production  # æ›´ä¸¥æ ¼çš„ä¾èµ–å®‰è£…
            if pm2 ls | grep -q yaren-server; then
              pm2 reload yaren-server --update-env
            else
              pm2 start main.js --name yaren-server
            fi
            pm2 save
            echo "ğŸ”§ å½“å‰æœåŠ¡çŠ¶æ€:"
            pm2 status
          EOF

      - name: æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
        run: rm -f deploy.tar.gz
=======
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: å®‰è£… SSH å¯†é’¥
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: unnecessary
        if_key_exists: replace
        
    - name: æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      run: ssh-keyscan -H 8.155.16.247 >> ~/.ssh/known_hosts
      
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        cd server
        rsync -avz --exclude 'node_modules' --exclude '.git' . root@8.155.16.247:/var/www/yaren-server/
        
    - name: è¿œç¨‹æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
      run: |
        ssh root@8.155.16.247 "cd /var/www/yaren-server && npm install --production && pm2 restart app.js || pm2 start app.js --name yaren-server"
>>>>>>> 48c938b10b3bd948b78d7ef2d4cb3cafafeb2f29
