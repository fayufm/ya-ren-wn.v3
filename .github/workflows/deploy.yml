name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ECSæœåŠ¡å™¨

on:
  push:
    branches: [ 1.0.1 ]  # è§¦å‘åˆ†æ”¯

env:
  SERVER_IP: 8.155.16.247
  DEPLOY_DIR: /var/www/yaren-server

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name:  æ£€å‡ºä»£ç 
        uses: actions/checkout@v3  # å‡çº§åˆ°æœ€æ–°ç‰ˆ

      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts  # é¢„ç½®ä¸»æœºæŒ‡çº¹æå‡å®‰å…¨æ€§

      - name: æµ‹è¯•SSHè¿æ¥ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
        run: |
          ssh -vvv \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -i ~/.ssh/id_rsa \
            root@${{ env.SERVER_IP }} \
            "echo 'âœ… SSHè¿æ¥æˆåŠŸï¼æœåŠ¡å™¨æ—¶é—´: $(date)'"

      - name: æ‰“åŒ…ä»£ç ï¼ˆæ’é™¤æ— ç”¨æ–‡ä»¶ï¼‰
        run: |
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.env' \
              --exclude='*.log' \
              -czf deploy.tar.gz .

      - name: ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨
        run: |
          scp -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=yes \
              deploy.tar.gz root@${{ env.SERVER_IP }}:${{ env.DEPLOY_DIR }}

      - name: æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ env.SERVER_IP }} << EOF
            set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³ç»ˆæ­¢
            cd $DEPLOY_DIR
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            npm ci --only=production  # æ›´ä¸¥æ ¼çš„ä¾èµ–å®‰è£…
            if pm2 ls | grep -q yaren-server; then
              pm2 reload yaren-server --update-env
            else
              pm2 start main.js --name yaren-server
            fi
            pm2 save
            echo "ğŸ”§ å½“å‰æœåŠ¡çŠ¶æ€:"
            pm2 status
          EOF

      - name: æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
        run: rm -f deploy.tar.gz